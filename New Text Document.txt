// ดึงค่าจาก payload JSON ที่ส่งจาก ESP32
var device = msg.payload["device_id"];
var temp = msg.payload["อุณหภูมิ"];
var humi = msg.payload["ความชื้น"];
var pres = msg.payload["ความดัน"];

// สร้าง SQL INSERT query
msg.topic = "INSERT INTO device_logs (device_id, temp, humidity, pressure) VALUES (?, ?, ?, ?)";
msg.payload = [device, temp, humi, pres];

return msg;

#include <WiFi.h>
#include <PubSubClient.h>
#include <Wire.h>
#include <BME280I2C.h>

WiFiClient w; PubSubClient c(w); BME280I2C bme;
int device_id = 12345678;

void setup() {
  Serial.begin(115200);
  WiFi.begin("IT-CMTC-WiFi","itcmtc1234");
  while(WiFi.status()!=WL_CONNECTED){delay(500); Serial.print(".");}
  Serial.println("\nWiFi connected: "+WiFi.localIP().toString());
  c.setServer("192.168.20.253",1883);
  Wire.begin(); if(!bme.begin()){Serial.println("BME280 error"); while(1) delay(1000);}
}

void reconnectMQTT(){while(!c.connected()){if(c.connect("ESP32-BME280"))Serial.println("MQTT connected"); else{Serial.println("MQTT failed"); delay(2000);}}}

void loop() {
  if(!c.connected()) reconnectMQTT();
  c.loop();
  float t,h,p; bme.read(p,t,h,BME280::TempUnit_Celsius,BME280::PresUnit_Pa);
  p /= 100.0; // Pa → hPa
  String s = "{\"device_id\":"+String(device_id)+",\"อุณหภูมิ\":"+String(t,2)+",\"ความชื้น\":"+String(h,2)+",\"ความดัน\":"+String(p,2)+"}";
  c.publish("sensor/bme280", s.c_str());
  Serial.print("device_id: "); Serial.print(device_id); Serial.print(" °C\t");
  Serial.print("อุณหภูมิ: "); Serial.print(t,2); Serial.print(" °C\t");
  Serial.print("ความชื้น: "); Serial.print(h,2); Serial.print("%\t");
  Serial.print("ความดัน: "); Serial.print(p,2); Serial.println(" hPa");
  delay(1000);
}
